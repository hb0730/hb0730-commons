language: java
jdk:
  - openjdk8
cache:
  directories:
    - '$HOME/.m2/repository'

notifications:
  email: false

before_install:
  - export TZ=Asia/Shanghai

jobs:
  include:
    - stage: build
      name: "maven build"
      script:
        - mvn clean package -DskipTests=true -Dmaven.javadoc.skip=true -B -V
        - mvn cobertura:cobertura -Dcobertura.report.format=xml -Dmaven.javadoc.skip.true -Dorg.slf4j.simpleLogger.defaultLogLevel=error
    - stage: GitHub Release
      script: echo "Deploying to GitHub releases ..." && pwd
      deploy:
        provider: releases
        api_key: $GITHUB_OAUTH_TOKEN
        file_glob: true
        skip_cleanup: true
        on:
          tags: true

stages:
  - build
  - name: GitHub Release
    if: tag =~ /^v\d+\.\d+(\.\d+)?(-\S*)?$/
branches:
  only:
    - master
    - dev
    - /^v\d+\.\d+(\.\d+)?(-\S*)?$/

after_success:
  - bash <(curl -s https://codecov.io/bash)
